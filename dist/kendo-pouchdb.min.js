/* kendo-pouchdb v0.0.8 21-05-2015 (C) 2015 Terikon Software */

!function(a,b){b(["PouchDB","pouchCollate"],a)}(function(a,b){if(!a)throw new Error('Please include "pouchdb.js" before kendo-pouchdb');if(!b)throw new Error('Please include "pouchdb-collate.js" before kendo-pouchdb');return function(c){var d=kendo.data.RemoteTransport.extend({init:function(b){var c=b&&b.pouchdb?b.pouchdb:{},d=c.db,e=c.idField,f=c.defaultView,g=c.fieldViews||{};if(!d)throw new Error('The "db" option must be set.');if(!(d instanceof a))throw new Error('The "db" option must be a PouchDB object.');if(!e)throw new Error('The "idField" option must be set.');this.db=d,this.idField=e,this.defaultView=f,this.fieldViews=g,this.dataSource=b.data.dataSource,kendo.data.RemoteTransport.fn.init.call(this,b)},push:function(a){var b=this,d=this.db.changes({since:"now",live:!0,include_docs:!0,filter:b.defaultView?"_view":void 0,view:b.defaultView});d.on("change",function(d){var e,f=b._crudPromises.slice(),g=d.doc;c.when.apply(c,f).then(function(){if(d.deleted)a.pushDestroy(g);else if(e=b.dataSource.get(g._id),void 0!==e){if(g._rev===e._rev)return;a.pushUpdate(g)}else b.dataSource.pageSize()||a.pushCreate(g)})}),d.on("error",function(a){})},read:function(b){var d,e,f,g,h=this,i=h._getFieldViewAndDirForSort(b.data.sort),j=!!i.fieldView,k=j?h.db.query.bind(h.db,i.fieldView):h.db.allDocs,l=b.data.pageSize,m=b.data.page,n=function(){return j||d?a.utils.Promise.resolve(0):h.db.allDocs({startkey:"_design/",endkey:"_designï¿¿"}).then(function(a){return a.rows.length})};h._validateFilter(b.data.filter,b.data.sort),g=this._getFilterQueryOptions(b.data.filter),d=!!g,void 0!==l?(void 0===m&&(m=1),f=l*(m-1)):f=void 0,e=void 0!==f||void 0!==l;var o=c.extend({include_docs:!1,reduce:"_count"},g),p=c.extend({include_docs:!0,descending:i.descending,skip:f,limit:l},g);n().then(function(a){return k.call(h.db,p).then(function(b){return j||d?e?k.call(h.db,o).then(function(a){return j?(b.total_rows=a.rows.length,b):(b.total_rows=a.rows.length,b)}):(b.total_rows=0,c.each(b.rows,function(){0!==this.doc._id.indexOf("_design/")&&(b.total_rows+=1)}),b):(b.total_rows-=a,b)})}).then(function(a){b.success(a)})["catch"](function(a){b.error([],a.status,a)})},_crudPromises:[],_crud:function(a,b,d,e){var f=this,g=new c.Deferred,h=g.promise(),i=function(){g.resolve();var a=f._crudPromises.indexOf(h);f._crudPromises.splice(a,1)};this._crudPromises.push(h),e.call(this,b).then(function(a){b._rev=a.rev,d.success(b),i()})["catch"](function(b){409===b.status&&console.log(kendo.format("kendo-pouchdb: conflict occured for {0}: {1}",a,b)),d.error([],b.status,b),i()})},create:function(a){var c=a.data;c._id=b.toIndexableString(c[this.idField]),this._crud("create",c,a,function(a){return this.db.put(a)})},update:function(a){var b=a.data;this._crud("update",b,a,function(a){return this.db.put(a)})},destroy:function(a){var b=a.data;this._crud("destroy",b,a,function(a){return this.db.remove(a)})},_getFieldViewAndDirForSort:function(a){var b,c,d,e=this.defaultView;if(!a||0===a.length)return{fieldView:e,descending:!1};if(a.length>1)throw new Error("Sorting by multiple fields is not supported by kendo-pouchdb");if(b=a[0].field,c=a[0].dir&&"desc"===a[0].dir,"_id"===b||b===this.idField)return{fieldView:e,descending:c};if(d=this.fieldViews[b],!d)throw new Error("No PouchDB view provided for sorting by '"+b+"'");return{fieldView:d,descending:c}},_validateFilter:function(a,b){},_getFilterQueryOptions:function(a){if(!a||0===a.filters.length)return void 0;var c=a.filters[0].field,d=a.filters[0].operator,e=c===this.idField||"_id"===c?b.toIndexableString(a.filters[0].value):a.filters[0].value;if(["neq","gt"].indexOf(d)>=0)throw new Error(kendo.format("{0} operator is currently not supported for field '{1}'",d,c));switch(d){case"eq":return{key:e};case"lt":return{endkey:e,inclusive_end:!1};case"lte":return{endkey:e,inclusive_end:!0};case"gte":return{startkey:e}}return void 0},_filterToSelector:function(a,b){a=a||{};var d=this,e={},f=a.logic||"and",g=a.filters||[],h="and"===f?"$and":"$or",i=[],j=function(a){switch(a){case"eq":return"$eq";case"neq":return"$ne";case"lt":return"$lt";case"lte":return"$lte";case"gt":return"$gt";case"gte":return"$gte";default:throw new Error(kendo.format("Operator {0} is not supported by kendo-pouchdb",a))}};return c.each(g,function(a,c){var e,f,g,h=c.field,k=c.value;c.filters?f=d._filterToSelector(c,b):(f={},e=j(c.operator),g={},g[e]=k,f[h]=g),i.push(f)}),0===i.length?null:(e[h]=i,e)}}),e={type:"json",data:function(a){if(a.rows){var b=c.map(a.rows,function(a){return 0!==a.doc._id.indexOf("_design/")?a.doc:void 0});return b}return a},total:function(a){return a.total_rows}};c.extend(!0,kendo.data,{schemas:{pouchdb:e},transports:{pouchdb:d}});var f=kendo.data.DataSource.extend({init:function(a){if(a&&a.type&&"pouchdb"===a.type){var b;if(a=c.extend(!0,{},a),this._ispouchdb=!0,a.schema&&a.schema.model&&a.schema.model.fn&&a.schema.model.fn instanceof kendo.data.Model){if(b=a.schema.model,"_id"!==b.idField)throw new Error('The Model\'s id option should be "_id"')}else if(a=c.extend(!0,{schema:{model:{id:"_id"}}},a),"_id"!==a.schema.model.id)throw new Error('The model.id option should not be provided or should be "_id"');if(a.serverPaging=void 0===a.serverPaging?!0:a.serverPaging,a.serverFiltering=void 0===a.serverFiltering?!0:a.serverFiltering,a.serverSorting=void 0===a.serverSorting?!0:a.serverSorting,a.serverGrouping=void 0===a.serverGrouping?!0:a.serverGrouping,a.serverAggregates=void 0===a.serverAggregates?!0:a.serverAggregates,a.data)throw new Error("For DataSource of type pouchdb data option should not be provided");a.data={dataSource:this}}kendo.data.DataSource.fn.init.apply(this,arguments)},getByModelId:function(a){return this._ispouchdb?kendo.data.DataSource.fn.get.call(this,b.toIndexableString(a)):kendo.data.DataSource.fn.get.apply(this,arguments)}});f.create=kendo.data.DataSource.create,kendo.data.PouchableDataSource=f}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(a,b){b(window.PouchDB,window.pouchCollate)});
//# sourceMappingURL=kendo-pouchdb.min.js.map