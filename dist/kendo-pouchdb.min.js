/* kendo-pouchdb v0.0.2 25-04-2015 (C) 2015 Terikon Software */

!function(a,b){b(["PouchDB","pouchCollate"],a)}(function(a,b){if(!a)throw new Error('Please include "pouchdb.js" before kendo-pouchdb');if(!b)throw new Error('Please include "pouchdb-collate.js" before kendo-pouchdb');return function(c){var d=kendo.data.RemoteTransport.extend({init:function(b){var c=b&&b.pouchdb?b.pouchdb:{},d=c.db,e=c.idField,f=c.fieldViews||{};if(!d)throw new Error('The "db" option must be set.');if(!(d instanceof a))throw new Error('The "db" option must be a PouchDB object.');if(this.db=d,!e)throw new Error('The "idField" option must be set.');this.idField=e,this.fieldViews=f,kendo.data.RemoteTransport.fn.init.call(this,b)},push:function(a){this.db.changes({since:"now",live:!0,include_docs:!0}).on("change",function(b){b.deleted?a.pushDestroy(b.doc):a.pushCreate(b.doc)}).on("error",function(a){})},read:function(a){var b,c=this,d=this._getFieldViewAndDirForSort(a.data.sort),e=d.fieldView?c.db.query.bind(c.db,d.fieldView):c.db.allDocs,f=a.data.pageSize,g=a.data.page,h=function(){return c.db.allDocs({startkey:"_design/",endkey:"_designï¿¿"}).then(function(a){return a.rows.length})};void 0!==f?(void 0===g&&(g=1),b=f*(g-1)):b=void 0,h().then(function(g){return e.call(c.db,{include_docs:!0,descending:d.descending,skip:b,limit:f}).then(function(b){b.total_rows-=g,a.success(b)})})["catch"](a.error)},_crud:function(a,b,c,d){d.call(this,b).then(function(a){b._rev=a.rev,c.success(b)})["catch"](function(b){409===b.status&&console.log(kendo.format("kendo-pouchdb: conflict occured for {0}: {1}",a,b)),c.error(b)})},create:function(a){var c=a.data;c._id=b.toIndexableString(c[this.idField]),this._crud("create",c,a,function(a){return this.db.put(a)})},update:function(a){var b=a.data;this._crud("update",b,a,function(a){return this.db.put(a)})},destroy:function(a){var b=a.data;this._crud("destroy",b,a,function(a){return this.db.remove(a)})},_getFieldViewAndDirForSort:function(a){var b,c,d;if(!a||0===a.length)return{descending:!1};if(a.length>1)throw new Error("Sorting by multiple fields is not supported by kendo-pouchdb");if(b=a[0].field,c=a[0].dir&&"desc"===a[0].dir,"_id"===b||b===this.idField)return{descending:c};if(d=this.fieldViews[b],!d)throw new Error("No PouchDB view provided for sorting by '"+b+"'");return{fieldView:d,descending:c}}}),e={type:"json",data:function(a){if(a.rows){var b=c.map(a.rows,function(a){return 0!==a.doc._id.indexOf("_design/")?a.doc:void 0});return b}return a},total:function(a){return a.total_rows}};c.extend(!0,kendo.data,{schemas:{pouchdb:e},transports:{pouchdb:d}});var f=kendo.data.DataSource.extend({init:function(a){if(a&&a.type&&"pouchdb"===a.type){var b;if(a=c.extend(!0,{},a),this._ispouchdb=!0,a.schema&&a.schema.model&&a.schema.model.fn&&a.schema.model.fn instanceof kendo.data.Model){if(b=a.schema.model,"_id"!==b.idField)throw new Error('The Model\'s id option should be "_id"')}else if(a=c.extend(!0,{schema:{model:{id:"_id"}}},a),"_id"!==a.schema.model.id)throw new Error('The model.id option should not be provided or should be "_id"');if(a.serverPaging=void 0===a.serverPaging?!0:a.serverPaging,a.serverFiltering=void 0===a.serverFiltering?!0:a.serverFiltering,a.serverSorting=void 0===a.serverSorting?!0:a.serverSorting,a.serverGrouping=void 0===a.serverGrouping?!0:a.serverGrouping,a.serverAggregates=void 0===a.serverAggregates?!0:a.serverAggregates,a.data)throw new Error("For DataSource of type pouchdb data option should not be provided");a.data={}}kendo.data.DataSource.fn.init.apply(this,arguments)},pushCreate:function(a){var b,c;return this._ispouchdb?(b=a[0],c=this.get(b._id),void 0!==c?b._rev!==c._rev?kendo.data.DataSource.fn.pushUpdate.apply(this,arguments):void 0:kendo.data.DataSource.fn.pushCreate.apply(this,arguments)):kendo.data.DataSource.fn.pushCreate.apply(this,arguments)},getByModelId:function(a){return this._ispouchdb?kendo.data.DataSource.fn.get.call(this,b.toIndexableString(a)):kendo.data.DataSource.fn.get.apply(this,arguments)}});f.create=kendo.data.DataSource.create,kendo.data.PouchableDataSource=f}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(a,b){b(window.PouchDB,window.pouchCollate)});
//# sourceMappingURL=kendo-pouchdb.min.js.map